name: Build Component Analyzer

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
        uses: actions/checkout@v4

      - name: âš™ï¸ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹
        run: |
          sudo apt-get update
          sudo apt-get install -y git python3 python3-pip cmake build-essential

      - name: ðŸ“¦ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÑƒ Flipper
        run: |
          git clone https://github.com/flipperdevices/flipperzero-firmware.git --depth=1
          cd flipperzero-firmware
          git submodule update --init --recursive --depth=1

      - name: ðŸ› ï¸ Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð² Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÑƒ
        run: |
          cd flipperzero-firmware
          mkdir -p applications_user/component_analyzer
          cp ../application.fam ../component_analyzer.c applications_user/component_analyzer/
          
          echo "=== ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð»Ð¾ÑÑŒ ==="
          ls -la applications_user/component_analyzer/
          echo "=== Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ .c Ñ„Ð°Ð¹Ð»Ð° (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 5 ÑÑ‚Ñ€Ð¾Ðº) ==="
          head -5 applications_user/component_analyzer/component_analyzer.c

      - name: ðŸš€ Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
        run: |
          cd flipperzero-firmware
          chmod +x fbt
          echo "=== Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ ==="
          ./fbt fap_dist DEBUG=0 2>&1 | tail -30

      - name: ðŸ” ÐÐ°Ð¹Ñ‚Ð¸ FAP-Ñ„Ð°Ð¹Ð» Ð“Ð”Ð• Ð£Ð“ÐžÐ”ÐÐž
        run: |
          cd flipperzero-firmware
          echo "=== Ð˜Ñ‰ÐµÐ¼ Ð’Ð•Ð—Ð”Ð• ==="
          find . -type f -name "*.fap" 2>/dev/null | head -10
          
          # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð²ÑÐµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¿ÑƒÑ‚Ð¸
          for path in "build/" "build/latest/" "build/f7-firmware-D/" "build/f7-debug/"; do
            if [ -d "$path" ]; then
              echo "=== Ð˜Ñ‰ÐµÐ¼ Ð² $path ==="
              find "$path" -type f -name "*.fap" 2>/dev/null | head -5
            fi
          done
          
          # Ð‘ÐµÑ€Ñ‘Ð¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ð¹ .fap Ñ„Ð°Ð¹Ð»
          FAP_FILE=$(find . -type f -name "*.fap" 2>/dev/null | head -1)
          if [ -n "$FAP_FILE" ]; then
            echo "âœ… ÐÐ°Ð¹Ð´ÐµÐ½ Ñ„Ð°Ð¹Ð»: $FAP_FILE"
            cp "$FAP_FILE" ../component_analyzer.fap
            echo "âœ… Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½ ÐºÐ°Ðº component_analyzer.fap"
            ls -lh ../component_analyzer.fap
          else
            echo "âŒ FAP-Ñ„Ð°Ð¹Ð» ÐÐ• ÐÐÐ™Ð”Ð•Ð"
            echo "=== ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ build/ ==="
            find build/ -type f 2>/dev/null | head -20 || echo "ÐŸÐ°Ð¿ÐºÐ° build Ð¿ÑƒÑÑ‚Ð°"
            echo "=== Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ Ñ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ð¼ Ð²Ñ‹Ð²Ð¾Ð´Ð¾Ð¼ ==="
            ./fbt -v fap_dist 2>&1 | tail -50
            exit 1
          fi

      - name: ðŸ“¤ Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚
        uses: actions/upload-artifact@v4
        with:
          name: component-analyzer-app
          path: component_analyzer.fap
          
