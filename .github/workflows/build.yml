name: Build Flipper App
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git python3 python3-pip cmake build-essential libusb-1.0-0-dev

      - name: ğŸ“¦ Clone Flipper Firmware
        run: |
          git clone https://github.com/flipperdevices/flipperzero-firmware.git --depth=1
          cd flipperzero-firmware
          git submodule update --init --recursive --depth=1

      # ĞĞ‘Ğ ĞĞ¢Ğ˜Ğ¢Ğ• Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ•: Ñƒ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑˆĞ°Ğ³Ğ° Ğ£ĞĞ˜ĞšĞĞ›Ğ¬ĞĞĞ• Ğ¸Ğ¼Ñ "Create App Structure"
      - name: ğŸ› ï¸ Create App Structure
        run: |
          cd flipperzero-firmware
          mkdir -p applications_user/gpio_tester
          echo 'App(appid="gpio_tester", name="GPIO Tester", apptype=FlipperAppType.EXTERNAL, entry_point=gpio_tester_app, stack_size=2048, icon="A_Plug_14x14")' > applications_user/gpio_tester/application.fam

      # Ğ Ñƒ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑˆĞ°Ğ³Ğ° Ğ¸Ğ¼Ñ "Create App Source Code"
      - name: ğŸ“ Create App Source Code
        run: |
          cd flipperzero-firmware
          echo '#include <furi.h>' > applications_user/gpio_tester/gpio_tester.c
          echo '#include <gui/gui.h>' >> applications_user/gpio_tester/gpio_tester.c
          echo '#include <input/input.h>' >> applications_user/gpio_tester/gpio_tester.c
          echo '' >> applications_user/gpio_tester/gpio_tester.c
          echo 'int32_t gpio_tester_app(void* p) {' >> applications_user/gpio_tester/gpio_tester.c
          echo '    UNUSED(p);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    return 0; // Simple working app' >> applications_user/gpio_tester/gpio_tester.c
          echo '}' >> applications_user/gpio_tester/gpio_tester.c

      - name: ğŸš€ Build Application
        run: |
          cd flipperzero-firmware
          chmod +x fbt
          ./fbt fap_gpio_tester

      - name: ğŸ“¤ Upload FAP File
        uses: actions/upload-artifact@v4
        with:
          name: gpio-tester-fap
          path: flipperzero-firmware/build/f7-firmware-D/.extapps/*.fap
