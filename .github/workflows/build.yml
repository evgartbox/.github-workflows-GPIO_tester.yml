name: Build Flipper App
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git python3 python3-pip cmake build-essential libusb-1.0-0-dev

      - name: ðŸ“¦ Clone Flipper Firmware
        run: |
          git clone https://github.com/flipperdevices/flipperzero-firmware.git --depth=1
          cd flipperzero-firmware
          git submodule update --init --recursive --depth=1

      - name: ðŸ› ï¸ Create App Files
        run: |
          cd flipperzero-firmware
          mkdir -p applications_user/gpio_tester
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ application.fam
          echo 'App(appid="gpio_tester", name="GPIO Tester", apptype=FlipperAppType.EXTERNAL, entry_point=gpio_tester_app, stack_size=2048, icon="A_Plug_14x14")' > applications_user/gpio_tester/application.fam
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ gpio_tester.h
          echo '#pragma once
#ifdef __cplusplus
extern "C" {
#endif
int32_t gpio_tester_app(void* p);
#ifdef __cplusplus
}
#endif' > applications_user/gpio_tester/gpio_tester.h
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ gpio_tester.c (ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ñ‹Ð¹, Ð½Ð¾ Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ð¹)
          echo '#include "gpio_tester.h"
#include <furi.h>
#include <gui/gui.h>
#include <input/input.h>

int32_t gpio_tester_app(void* p) {
    UNUSED(p);
    // ÐŸÑ€Ð¾ÑÑ‚ÐµÐ¹ÑˆÐµÐµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‰ÐµÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
    return 0;
}' > applications_user/gpio_tester/gpio_tester.c

      - name: ðŸš€ Build Application
        run: |
          cd flipperzero-firmware
          chmod +x fbt
          ./fbt fap_gpio_tester

      - name: ðŸ“¤ Upload FAP File
        uses: actions/upload-artifact@v4
        with:
          name: gpio-tester-fap
          path: flipperzero-firmware/build/f7-firmware-D/.extapps/*.fap
