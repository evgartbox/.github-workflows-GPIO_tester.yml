name: Build Flipper App
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git python3 python3-pip cmake build-essential libusb-1.0-0-dev

      - name: üì¶ Clone Flipper Firmware
        run: |
          git clone https://github.com/flipperdevices/flipperzero-firmware.git --depth=1
          cd flipperzero-firmware
          git submodule update --init --recursive --depth=1

            - name: üõ†Ô∏è Create Test App (FIXED)
        run: |
          cd flipperzero-firmware
          mkdir -p applications_user/gpio_tester

          # application.fam —Å –ü–†–ê–í–ò–õ–¨–ù–´–ú –∏–º–µ–Ω–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
          echo 'App(appid="gpio_tester", name="GPIO Tester", apptype=FlipperAppType.EXTERNAL, entry_point=gpio_tester_app, stack_size=2048, icon="A_Plug_14x14")' > applications_user/gpio_tester/application.fam

          # gpio_tester.c —Å –¢–û–ß–ù–û –¢–ê–ö–ò–ú –ñ–ï –∏–º–µ–Ω–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
          echo '#include <furi.h>' > applications_user/gpio_tester/gpio_tester.c
          echo '#include <gui/gui.h>' >> applications_user/gpio_tester/gpio_tester.c
          echo '#include <input/input.h>' >> applications_user/gpio_tester/gpio_tester.c
          echo '' >> applications_user/gpio_tester/gpio_tester.c
          echo 'int32_t gpio_tester_app(void* p) {' >> applications_user/gpio_tester/gpio_tester.c
          echo '    UNUSED(p);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    // –ü—Ä–æ—Å—Ç–µ–π—à–µ–µ —Ä–∞–±–æ—Ç–∞—é—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ' >> applications_user/gpio_tester/gpio_tester.c
          echo '    return 0;' >> applications_user/gpio_tester/gpio_tester.c
          echo '}' >> applications_user/gpio_tester/gpio_tester.c
      - name: üöÄ Build Application
        run: |
          cd flipperzero-firmware
          ./fbt fap_gpio_tester

      - name: üì§ Upload FAP File
        uses: actions/upload-artifact@v4
        with:
          name: gpio-tester-fap
          path: flipperzero-firmware/build/f7-firmware-D/.extapps/*.fap
