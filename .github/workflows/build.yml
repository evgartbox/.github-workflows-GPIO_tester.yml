name: Build Flipper App
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git python3 python3-pip cmake build-essential libusb-1.0-0-dev

      - name: üì¶ Clone Flipper Firmware
        run: |
          git clone https://github.com/flipperdevices/flipperzero-firmware.git --depth=1
          cd flipperzero-firmware
          git submodule update --init --recursive --depth=1

      - name: üõ†Ô∏è Create Test App
        run: |
          cd flipperzero-firmware
          mkdir -p applications_user/gpio_tester

          # –°–æ–∑–¥–∞—ë–º application.fam
          echo 'App(appid="gpio_tester", name="GPIO Tester", apptype=FlipperAppType.EXTERNAL, entry_point=gpio_tester_app, stack_size=2048, icon="A_Plug_14x14")' > applications_user/gpio_tester/application.fam

          # –°–æ–∑–¥–∞—ë–º gpio_tester.c - –ü–†–û–°–¢–û–ô –∏ –†–ê–ë–û–ß–ò–ô —Å–ø–æ—Å–æ–±
          echo '#include <furi.h>' > applications_user/gpio_tester/gpio_tester.c
          echo '#include <gui/gui.h>' >> applications_user/gpio_tester/gpio_tester.c
          echo '#include <input/input.h>' >> applications_user/gpio_tester/gpio_tester.c
          echo '' >> applications_user/gpio_tester/gpio_tester.c
          echo 'typedef struct {' >> applications_user/gpio_tester/gpio_tester.c
          echo '    Gui* gui;' >> applications_user/gpio_tester/gpio_tester.c
          echo '    ViewPort* view_port;' >> applications_user/gpio_tester/gpio_tester.c
          echo '    FuriMessageQueue* event_queue;' >> applications_user/gpio_tester/gpio_tester.c
          echo '} GpioTesterApp;' >> applications_user/gpio_tester/gpio_tester.c
          echo '' >> applications_user/gpio_tester/gpio_tester.c
          echo 'static void draw_callback(Canvas* canvas, void* ctx) {' >> applications_user/gpio_tester/gpio_tester.c
          echo '    UNUSED(ctx);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    canvas_clear(canvas);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    canvas_set_font(canvas, FontPrimary);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    canvas_draw_str(canvas, 10, 10, "GPIO Tester");' >> applications_user/gpio_tester/gpio_tester.c
          echo '    canvas_set_font(canvas, FontSecondary);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    canvas_draw_str(canvas, 10, 30, "OK: Test | Back: Exit");' >> applications_user/gpio_tester/gpio_tester.c
          echo '}' >> applications_user/gpio_tester/gpio_tester.c
          echo '' >> applications_user/gpio_tester/gpio_tester.c
          echo 'static void input_callback(InputEvent* input_event, void* ctx) {' >> applications_user/gpio_tester/gpio_tester.c
          echo '    GpioTesterApp* app = ctx;' >> applications_user/gpio_tester/gpio_tester.c
          echo '    furi_message_queue_put(app->event_queue, input_event, FuriWaitForever);' >> applications_user/gpio_tester/gpio_tester.c
          echo '}' >> applications_user/gpio_tester/gpio_tester.c
          echo '' >> applications_user/gpio_tester/gpio_tester.c
          echo 'int32_t gpio_tester_app(void* p) {' >> applications_user/gpio_tester/gpio_tester.c
          echo '    UNUSED(p);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    GpioTesterApp* app = malloc(sizeof(GpioTesterApp));' >> applications_user/gpio_tester/gpio_tester.c
          echo '    app->gui = furi_record_open(RECORD_GUI);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    app->event_queue = furi_message_queue_alloc(8, sizeof(InputEvent));' >> applications_user/gpio_tester/gpio_tester.c
          echo '' >> applications_user/gpio_tester/gpio_tester.c
          echo '    app->view_port = view_port_alloc();' >> applications_user/gpio_tester/gpio_tester.c
          echo '    view_port_draw_callback_set(app->view_port, draw_callback, NULL);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    view_port_input_callback_set(app->view_port, input_callback, app);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    gui_add_view_port(app->gui, app->view_port, GuiLayerFullscreen);' >> applications_user/gpio_tester/gpio_tester.c
          echo '' >> applications_user/gpio_tester/gpio_tester.c
          echo '    InputEvent event;' >> applications_user/gpio_tester/gpio_tester.c
          echo '    bool running = true;' >> applications_user/gpio_tester/gpio_tester.c
          echo '    while(running) {' >> applications_user/gpio_tester/gpio_tester.c
          echo '        if(furi_message_queue_get(app->event_queue, &event, 100) == FuriStatusOk) {' >> applications_user/gpio_tester/gpio_tester.c
          echo '            if(event.type == InputTypePress && event.key == InputKeyBack) {' >> applications_user/gpio_tester/gpio_tester.c
          echo '                running = false;' >> applications_user/gpio_tester/gpio_tester.c
          echo '            }' >> applications_user/gpio_tester/gpio_tester.c
          echo '        }' >> applications_user/gpio_tester/gpio_tester.c
          echo '        view_port_update(app->view_port);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    }' >> applications_user/gpio_tester/gpio_tester.c
          echo '' >> applications_user/gpio_tester/gpio_tester.c
          echo '    gui_remove_view_port(app->gui, app->view_port);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    view_port_free(app->view_port);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    furi_message_queue_free(app->event_queue);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    furi_record_close(RECORD_GUI);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    free(app);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    return 0;' >> applications_user/gpio_tester/gpio_tester.c
          echo '}' >> applications_user/gpio_tester/gpio_tester.c

      - name: üöÄ Build Application
        run: |
          cd flipperzero-firmware
          ./fbt fap_gpio_tester

      - name: üì§ Upload FAP File
        uses: actions/upload-artifact@v4
        with:
          name: gpio-tester-fap
          path: flipperzero-firmware/build/f7-firmware-D/.extapps/*.fap
