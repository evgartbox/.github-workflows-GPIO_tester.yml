name: Build Working Flipper App
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup environment
        run: |
          sudo apt update
          sudo apt install -y git python3 python3-pip cmake
          
      - name: Get firmware
        run: |
          git clone https://github.com/flipperdevices/flipperzero-firmware.git fw
          cd fw
          # Критически важно: инициализируем подмодули!
          git submodule update --init --recursive
          
      - name: Create working app
        run: |
          cd fw
          mkdir -p applications_user/my_app
          
          # 1. application.fam - ОДНА строка
          echo 'App(appid="my_app", name="My Test App", apptype=FlipperAppType.EXTERNAL, entry_point=my_app, stack_size=1024, icon="A_Plug_14x14")' > applications_user/my_app/application.fam
          
          # 2. my_app.c - МИНИМАЛЬНЫЙ рабочий код
          echo '#include <furi.h>' > applications_user/my_app/my_app.c
          echo 'int32_t my_app(void* p) {' >> applications_user/my_app/my_app.c
          echo '    UNUSED(p);' >> applications_user/my_app/my_app.c
          echo '    // Простейшее работающее приложение' >> applications_user/my_app/my_app.c
          echo '    return 0;' >> applications_user/my_app/my_app.c
          echo '}' >> applications_user/my_app/my_app.c
          
      - name: Build app
        run: |
          cd fw
          # Даем права и собираем
          chmod +x fbt
          ./fbt fap_dist
          
      - name: Find and show results
        run: |
          cd fw
          echo "=== Поиск .fap файлов ==="
          find . -name "*.fap" -type f
          
          # Показываем структуру build
          echo "=== Содержимое build/ ==="
          ls -la build/ || echo "Нет папки build"
          ls -la build/*/ 2>/dev/null || echo "Нет подпапок"
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flipper-app
          path: fw/build/f7-firmware-D/.extapps/*.fap
