name: Build Simple GPIO Test
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup
        run: |
          sudo apt update
          sudo apt install -y git python3 python3-pip cmake
          
      - name: Clone and build
        run: |
          # Клонируем прошивку
          git clone https://github.com/flipperdevices/flipperzero-firmware.git fw --depth=1
          cd fw
          
          # Создаем ПРОСТЕЙШЕЕ работающее приложение
          mkdir -p applications_user/test_app
          
          # application.fam
          echo 'App(appid="test_app", name="Test App", apptype=FlipperAppType.EXTERNAL, entry_point=test_app, stack_size=1024, icon="A_Plug_14x14")' > applications_user/test_app/application.fam
          
          # Простейший .c файл, который ТОЧНО сработает
          echo '#include <furi.h>' > applications_user/test_app/test_app.c
          echo 'int32_t test_app(void* p) {' >> applications_user/test_app/test_app.c
          echo '    UNUSED(p);' >> applications_user/test_app/test_app.c
          echo '    return 0;' >> applications_user/test_app/test_app.c
          echo '}' >> applications_user/test_app/test_app.c
          
          # Собираем
          ./fbt fap_dist DEBUG=0
          
          # Ищем и копируем результат
          find . -name "*.fap" -type f
          cp $(find . -name "*.fap" -type f | head -1) ../test_app.fap
          
      - uses: actions/upload-artifact@v4
        with:
          name: test-app
          path: test_app.fap
