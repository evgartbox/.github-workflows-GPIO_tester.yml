name: Build Flipper App
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup environment
        run: |
          sudo apt update
          sudo apt install -y git python3 python3-pip cmake libusb-1.0-0-dev
          
      - name: Clone firmware
        run: |
          git clone https://github.com/flipperdevices/flipperzero-firmware.git --depth=1
          cd flipperzero-firmware
          git submodule update --init --recursive --depth=1
          
      - name: Install Python dependencies
        run: |
          cd flipperzero-firmware
          pip3 install -r scripts/requirements.txt
          
      - name: Create app files
        run: |
          cd flipperzero-firmware
          APP_DIR="applications_user/gpio_test"
          mkdir -p $APP_DIR
          
          # application.fam - ОДНА строка
          echo 'App(appid="gpio_test", name="GPIO Test", apptype=FlipperAppType.EXTERNAL, entry_point=gpio_test_app, stack_size=2048, icon="A_Plug_14x14")' > $APP_DIR/application.fam
          
          # gpio_test.h - простой
          echo '#pragma once' > $APP_DIR/gpio_test.h
          echo 'int32_t gpio_test_app(void* p);' >> $APP_DIR/gpio_test.h
          
          # gpio_test.c - построчно, без сложных конструкций
          echo '#include "gpio_test.h"' > $APP_DIR/gpio_test.c
          echo '#include <furi.h>' >> $APP_DIR/gpio_test.c
          echo '#include <gui/gui.h>' >> $APP_DIR/gpio_test.c
          echo '#include <input/input.h>' >> $APP_DIR/gpio_test.c
          echo '' >> $APP_DIR/gpio_test.c
          echo 'static void draw_callback(Canvas* canvas, void* ctx) {' >> $APP_DIR/gpio_test.c
          echo '    UNUSED(ctx);' >> $APP_DIR/gpio_test.c
          echo '    canvas_clear(canvas);' >> $APP_DIR/gpio_test.c
          echo '    canvas_set_font(canvas, FontPrimary);' >> $APP_DIR/gpio_test.c
          echo '    canvas_draw_str(canvas, 10, 10, "GPIO Test OK!");' >> $APP_DIR/gpio_test.c
          echo '}' >> $APP_DIR/gpio_test.c
          echo '' >> $APP_DIR/gpio_test.c
          echo 'static void input_callback(InputEvent* input_event, void* ctx) {' >> $APP_DIR/gpio_test.c
          echo '    FuriMessageQueue* event_queue = ctx;' >> $APP_DIR/gpio_test.c
          echo '    furi_message_queue_put(event_queue, input_event, FuriWaitForever);' >> $APP_DIR/gpio_test.c
          echo '}' >> $APP_DIR/gpio_test.c
          echo '' >> $APP_DIR/gpio_test.c
          echo 'int32_t gpio_test_app(void* p) {' >> $APP_DIR/gpio_test.c
          echo '    UNUSED(p);' >> $APP_DIR/gpio_test.c
          echo '    FuriMessageQueue* event_queue = furi_message_queue_alloc(8, sizeof(InputEvent));' >> $APP_DIR/gpio_test.c
          echo '    ViewPort* view_port = view_port_alloc();' >> $APP_DIR/gpio_test.c
          echo '    view_port_draw_callback_set(view_port, draw_callback, NULL);' >> $APP_DIR/gpio_test.c
          echo '    view_port_input_callback_set(view_port, input_callback, event_queue);' >> $APP_DIR/gpio_test.c
          echo '    Gui* gui = furi_record_open(RECORD_GUI);' >> $APP_DIR/gpio_test.c
          echo '    gui_add_view_port(gui, view_port, GuiLayerFullscreen);' >> $APP_DIR/gpio_test.c
          echo '    InputEvent event;' >> $APP_DIR/gpio_test.c
          echo '    bool running = true;' >> $APP_DIR/gpio_test.c
          echo '    while(running) {' >> $APP_DIR/gpio_test.c
          echo '        if(furi_message_queue_get(event_queue, &event, FuriWaitForever) == FuriStatusOk) {' >> $APP_DIR/gpio_test.c
          echo '            if(event.type == InputTypePress && event.key == InputKeyBack) {' >> $APP_DIR/gpio_test.c
          echo '                running = false;' >> $APP_DIR/gpio_test.c
          echo '            }' >> $APP_DIR/gpio_test.c
          echo '        }' >> $APP_DIR/gpio_test.c
          echo '        view_port_update(view_port);' >> $APP_DIR/gpio_test.c
          echo '    }' >> $APP_DIR/gpio_test.c
          echo '    gui_remove_view_port(gui, view_port);' >> $APP_DIR/gpio_test.c
          echo '    view_port_free(view_port);' >> $APP_DIR/gpio_test.c
          echo '    furi_message_queue_free(event_queue);' >> $APP_DIR/gpio_test.c
          echo '    furi_record_close(RECORD_GUI);' >> $APP_DIR/gpio_test.c
          echo '    return 0;' >> $APP_DIR/gpio_test.c
          echo '}' >> $APP_DIR/gpio_test.c
          
      - name: Build application
        run: |
          cd flipperzero-firmware
          chmod +x fbt
          ./fbt fap_dist DEBUG=0
          
      - name: Find FAP file
        run: |
          cd flipperzero-firmware
          echo "Ищем FAP файлы..."
          find . -name "*.fap" -type f
          FAP_FILE=$(find . -name "gpio_test.fap" -type f | head -1)
          if [ -z "$FAP_FILE" ]; then
            FAP_FILE=$(find . -name "*.fap" -type f | head -1)
          fi
          if [ -n "$FAP_FILE" ]; then
            echo "Найден: $FAP_FILE"
            cp "$FAP_FILE" ../app.fap
          else
            echo "FAP не найден"
            exit 1
          fi
          
      - name: Upload FAP
        uses: actions/upload-artifact@v4
        with:
          name: flipper-app
          path: app.fap
