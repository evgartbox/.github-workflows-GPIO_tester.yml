name: Build Component Analyzer

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: üì• –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
        run: |
          sudo apt-get update
          sudo apt-get install -y git python3 python3-pip cmake build-essential

      - name: üì¶ –°–∫–∞—á–∞—Ç—å –ø—Ä–æ—à–∏–≤–∫—É Flipper
        run: |
          git clone https://github.com/flipperdevices/flipperzero-firmware.git --depth=1
          cd flipperzero-firmware
          git submodule update --init --recursive --depth=1

      - name: üõ†Ô∏è –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –ø—Ä–æ—à–∏–≤–∫—É
        run: |
          cd flipperzero-firmware
          mkdir -p applications_user/component_analyzer
          cp ../application.fam ../component_analyzer.c applications_user/component_analyzer/

      - name: üöÄ –°–æ–±—Ä–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        run: |
          cd flipperzero-firmware
          chmod +x fbt
          ./fbt fap_dist DEBUG=0

      - name: üì§ –ù–∞–π—Ç–∏ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å .fap —Ñ–∞–π–ª
        run: |
          cd flipperzero-firmware
          # –ò—â–µ–º –ª—é–±–æ–π —Å–æ–∑–¥–∞–Ω–Ω—ã–π .fap —Ñ–∞–π–ª
          find . -name "*.fap" -type f
          FAP_FILE=$(find . -name "*.fap" -type f | head -1)
          if [ -n "$FAP_FILE" ]; then
            echo "–ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª: $FAP_FILE"
            cp "$FAP_FILE" ../component_analyzer.fap
          else
            echo "–û–®–ò–ë–ö–ê: .fap —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi

      - name: ‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç (–≥–æ—Ç–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
        uses: actions/upload-artifact@v4
        with:
          name: component-analyzer-app
          path: component_analyzer.fap
