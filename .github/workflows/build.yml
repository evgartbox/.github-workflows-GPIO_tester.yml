name: Build Flipper App
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git python3 python3-pip cmake build-essential libusb-1.0-0-dev
      - name: Clone Flipper Firmware
        run: |
          git clone https://github.com/flipperdevices/flipperzero-firmware.git --depth=1
          cd flipperzero-firmware
          git submodule update --init --recursive --depth=1
      - name: Create App Files
        run: |
          cd flipperzero-firmware
          mkdir -p applications_user/gpio_tester
          echo 'App(appid="gpio_tester", name="GPIO Tester", apptype=FlipperAppType.EXTERNAL, entry_point=gpio_tester_app, stack_size=2048, icon="A_Plug_14x14")' > applications_user/gpio_tester/application.fam
          echo '#pragma once' > applications_user/gpio_tester/gpio_tester.h
          echo 'int32_t gpio_tester_app(void* p);' >> applications_user/gpio_tester/gpio_tester.h
          echo '#include "gpio_tester.h"' > applications_user/gpio_tester/gpio_tester.c
          echo '#include <furi.h>' >> applications_user/gpio_tester/gpio_tester.c
          echo '' >> applications_user/gpio_tester/gpio_tester.c
          echo 'int32_t gpio_tester_app(void* p) {' >> applications_user/gpio_tester/gpio_tester.c
          echo '    UNUSED(p);' >> applications_user/gpio_tester/gpio_tester.c
          echo '    return 0;' >> applications_user/gpio_tester/gpio_tester.c
          echo '}' >> applications_user/gpio_tester/gpio_tester.c
      - name: Build Application
        run: |
          cd flipperzero-firmware
          chmod +x fbt
          ./fbt fap_dist DEBUG=0 APPID=gpio_tester
      - name: Upload FAP File
        uses: actions/upload-artifact@v4
        with:
          name: gpio-tester-fap
          path: flipperzero-firmware/build/f7-firmware-D/.extapps/*.fap
      - name: ðŸŽ¯ ÐŸÑ€Ð¾ÑÑ‚Ð¾ ÑÐ¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð¸ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ
        run: |
          cd flipperzero-firmware
          echo "=== Ð§Ñ‚Ð¾ Ð²Ð¾Ð¾Ð±Ñ‰Ðµ ÑÐ¾Ð±Ñ€Ð°Ð»Ð¾ÑÑŒ? ==="
          ./fbt -v fap_dist 2>&1 | grep -A5 -B5 "fap\|FAP\|build" | tail -50
